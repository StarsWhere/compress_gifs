# GIF 批量压缩脚本（compress_gifs.sh）

该脚本会递归扫描输入目录内的所有 `.gif` 文件，使用 ffmpeg 多档位压缩+二分搜索策略，将输出控制在指定大小上限附近，并保持与输入目录一致的相对路径结构输出到目标目录。可选地，会把时长归一化到指定范围内。

## 依赖

- Bash
- ffmpeg / ffprobe
- 常用工具：`find`, `realpath`, `stat`, `mktemp`, `awk`

> 在 Windows 上建议使用 WSL 或 Git Bash 运行。

## 用法

```bash
./scripts/compress_gifs.sh <input_dir> <output_dir>
```

示例：

```bash
./scripts/compress_gifs.sh ./gifs_in ./gifs_out
```

## 可选环境变量

- `MAX_MB`：目标体积上限（默认 **9MB**）
- `MAX_W`：最大宽度（默认 **1024**，按原图等比缩放，即使体积已达标也会确保不超过此宽度）
- `TOL_MB`：允许误差范围（默认 **1MB**）
- `DUR_MIN`：允许的最短时长秒数（默认 **0**）
- `DUR_MAX`：允许的最长时长秒数（默认 **4**）
- `DUR_EPS`：时长比较容差秒（默认 **0.02**，用于避免 ffprobe 浮点误差）
- `VERBOSE_TRIALS`：设为 `1` 时打印每个档位的结果（默认 `0`）
- `SHOW_FFMPEG`：设为 `1` 时显示 ffmpeg 的输出（默认 `0`）

示例：

```bash
MAX_MB=8 TOL_MB=1 MAX_W=960 ./scripts/compress_gifs.sh ./gifs_in ./gifs_out
```

## 前端站点（浏览器端压缩）

- 打开 `index.html` 即可离线使用；核心逻辑与脚本一致，默认预设为“微信表情包”。
- 压缩在浏览器完成，依赖 ffmpeg.wasm；如浏览器支持 WebGPU，会自动用于像素计算加速。

## 行为说明

- 递归查找输入目录下所有 `.gif`（大小写不敏感）。
- 输出目录会自动创建，且保持相同的目录结构。
- 仅当体积、宽度、时长同时满足要求时才直接复制；否则会重新编码。
- 若时长不在 `[DUR_MIN, DUR_MAX]` 范围内，会通过 `setpts` 加速/减速到最近的边界，帧数不变。
- 压缩档位组合包含宽度、帧率（或 `keep` 保持原时间轴）、颜色数，并用二分搜索快速逼近目标体积；当仅需缩放或调时长时，会优先尝试保留原帧间隔的档位。
- 若原图宽度无法探测，会强制重新编码并视为需要缩放，以确保不超过 `MAX_W`。
- 命中容差的条件是：压缩后体积 ≤ `MAX_MB` 且与目标差值 ≤ `TOL_MB`；否则会挑选“最接近目标”的结果并记为 WARN。
- 如果没有档位能落在误差范围内，脚本仍会输出“最接近目标”的结果，并将该文件标记为 WARN。

## 退出码

- `0`：所有文件都在允许范围内完成压缩。
- `1`：有文件未落在容差范围内，但仍输出了最接近的结果。
- `2`：用法错误或缺少依赖命令。

> 日志末尾会汇总 OK/WARN 计数；出现 WARN 时返回码为 1，便于在批处理/CI 中发现“未命中容差”的文件。

## 提示

- 若图片尺寸较大且压缩困难，可适当调低 `MAX_W` 或 `MAX_MB`。
- 脚本内部使用多档位策略（帧率、颜色数、宽度组合）和二分搜索，尽量在清晰度与体积间折中。
