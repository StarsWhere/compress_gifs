# GIF 压缩站点设计文档

## 1. 产品定位
- 纯前端 GIF 压缩与尺寸/时长规范工具，默认预设名 **“微信表情包”**。
- 不落服务器数据：所有文件/预设/历史只存储于浏览器（IndexedDB + localStorage），刷新后依然可用。
- 允许用户创建/切换自定义参数集，支持批量压缩与日志查看。
- 设计原则：对新人“零学习成本”，对高手“零阻碍”——默认一键用好，进阶能力显眼可触达。

## 2. 默认参数（映射自 `compress_gifs.sh`）
- `MAX_MB=10`（目标体积上限）
- `MAX_W=1024`（最大宽度，即使已达标仍会限宽）
- `TOL_MB=1`（误差容差）
- `DUR_MIN=0`，`DUR_MAX=4`，`DUR_EPS=0.02`（时长范围及比较容差）
- `VERBOSE_TRIALS=0`，`SHOW_FFMPEG=0`（日志与 ffmpeg 输出开关）
- 档位序列：
  - `prefer_keep_timing=1` 时优先：`$max_w keep 256`，`$max_w keep 192`，`$max_w keep 160`
  - 常规：`$max_w 18 256` → `$max_w 15 256` → `$max_w 12 192` → `960 12 192` → `832 10 160` → `768 10 128` → `640 8 128` → `576 8 96` → `512 8 96` → `448 6 80` → `384 5 64` → `320 4 64` → `256 4 48` → `256 4 32`

## 3. 架构概览
- **前端应用**：Vite + TypeScript（或 Svelte/Vue 任选），无后端。
- **核心引擎**：`@ffmpeg/ffmpeg`（WASM，多线程+SIMD），在 Web Worker 中运行。
- **GPU 渐进增强**：如可用，则用 WebGPU 处理缩放/调色板等像素计算；不可用时退回 WASM 纯 CPU 路径。
- **数据存储**：
  - `localStorage`：当前预设、UI 偏好、上次使用的参数集 ID。
  - `IndexedDB`：任务历史索引（文件名、参数、日志摘要、输出元信息）；压缩产物二进制默认仅驻内存，用户可选“保留输出”时再写入。
- **安全与隐私**：无网络上传；仅在本地浏览器沙箱内处理。

## 4. 压缩流程（脚本逻辑的前端等价）
1) 解析参数与输入 GIF 元信息（宽度/时长/体积）。
2) 判断是否需要：限体积、限宽、限时长。若三者均达标则直接复制。
3) 若需处理，构造档位数组 `build_profiles(prefer_keep_timing)`；先试最轻档、再试最重档、然后二分中间档位。
4) 每档位：
   - 生成调色板：`palettegen=max_colors=${colors}:stats_mode=diff:reserve_transparent=1`。
   - 应用 `setpts` 做时长归一（仅当超界时），`fps` 为数字则重采样，否则保持原节奏。
   - `scale='min(iw,w)':-1:flags=lanczos` 缩放并编码。
   - 记录体积差 `diff` 与方向 `side`；更新最优解；命中条件为 `size<=target && diff<=tol`。
5) 终局：如果命中容差则返回该档；否则返回最接近目标的档，并标注为“WARN”。

## 5. GPU 方案与回退
- **检测**：`if (navigator.gpu)` → WebGPU 路径；否则 CPU 路径。
- **WebGPU 责任**：
  - Compute shader 完成缩放（bilinear/lanczos 近似）与颜色量化/抖动。
  - 可在 GPU 上做 `setpts` 等时间伸缩时的帧重采样。
  - 输出 RGBA 帧通过 `SharedArrayBuffer` 传递给 WASM，最终 GIF 打包仍在 CPU。
- **CPU 路径优化**：使用 multithread + SIMD 版 ffmpeg.wasm；限制并行任务数，释放中间缓冲。
- **UI 提示**：状态徽标显示“GPU 加速 / CPU 模式”，并告知可能的性能差异。

## 6. 主要界面与交互
- 左列：预设选择（默认“微信表情包”）、参数表单、开关 `prefer_keep_timing/verbose/show_ffmpeg`、批量按钮。
- 右侧：拖拽/点击上传区；任务列表展示缩略图、原/新体积、宽度、时长、档位 idx、耗时、是否命中容差；操作按钮（下载、查看日志、用当前档重试）。
- 顶部状态条：WASM/WebGPU 加载进度、任务队列数、存储占用提示。
- 日志面板：镜像脚本的 `log` 风格，可折叠；错误时提供“保留原图”与“降级档位”选项。
- 新手友好：
  - “一键压缩”主按钮，默认预设即刻可用；空态提示“拖拽 GIF 或点击选择”，附示例 GIF 下载。
  - 参数表单折叠为“高级设置”；默认仅显示上限体积与宽度两个核心字段。
  - 结果卡用红/绿标注是否达标，提供“重新压到更小”快捷按钮，无需理解档位。
- 高阶可定制：
  - 高级面板包含所有脚本参数、档位偏好（keep timing 开关）、日志等级、并发数、GPU 优先级。
  - 预设可导入/导出 JSON，便于分享；可锁定某预设为“批量默认”。
  - “专家模式”开关：显示每次尝试的档位参数、尺寸差、命中容差与二分方向；允许手动指定档位顺序或自定义档位表。

## 7. 存储与隐私策略
- 默认不保留原/压缩后的二进制文件；仅存任务元信息（名称、时间、参数、结果尺寸）；用户可勾选“保存输出到本地缓存”时再写入 IndexedDB。
- 所有数据留在本地；无网络上传。

## 8. 里程碑
1) 打通最小可用版本：单 GIF、固定默认参数、CPU 路径；展示日志与对比。
2) 完整移植档位/二分/时长归一逻辑；批量任务队列；预设 CRUD + 持久化。
3) WebGPU 加速版本（可开关）；性能回归测试与降级验证。
4) UI 打磨：状态条、日志面板、历史记录、下载 Zip 选项；中/英文文案。
5) PWA 可选：缓存 WASM 与核心 JS，离线可用。

## 9. 测试与验收
- 基准集：高分辨率长 GIF、透明通道表情包、低帧率长宽条、超长时长/超大体积案例。
- 结果对比：与原 `compress_gifs.sh` 输出的体积、宽度、时长、档位一致性；误差容差判定一致。
- 兼容性：Chrome/Edge/Safari（桌面+移动），WebGPU 关闭场景；内存压力与并发 2–3 条验证。

## 10. 风险与应对
- WebGPU 可用性不一致：默认 CPU 路径稳态，GPU 仅为加速选项。
- 大文件 OOM：限制同时处理任务数、分块读取、及时释放帧缓存。
- WASM 体积与首屏时间：懒加载 + 进度提示，缓存到 IndexedDB；失败时提示改用本地脚本。
